<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Moderustic:wght@300..800&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Oswald:wght@200..700&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Varela&display=swap" rel="stylesheet">

    <title>Valoração - Planaflor</title>

    <!-- Biblioteca D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.4/d3.min.js"></script>
    <style>
        .chart {
            margin-top: 20px;
        }
        .bar:hover {
            fill: orange;
        }
        .tooltip {
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .dropdown {
            margin-bottom: 20px;
        }
        .radio-group {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="topnav">
        <div>
            <img src="https://asset.brandfetch.io/idRUcHpOLl/idoBOKuc1d.png" alt="Logo da Organização" />
        </div>
        <h1 style="display: inline;">Resultados da Valoração</h1>
        <p>Atualizado em: 24/10/2024</p>

    </div>

    <!-- Dropdown para selecionar o Cenário -->
    <div class="dropdown">
        <label for="cenarioSelect">Selecione o Cenário: </label>
        <select id="cenarioSelect">
            <option value="all">Todos os Cenários</option>
        </select>
    </div>

    <!-- Radio buttons para escolher entre Valores Absolutos e Valores por Hectare -->
    <div class="radio-group">
        <label><input type="radio" name="valueType" value="Valor" checked> Valores Absolutos</label>
        <label><input type="radio" name="valueType" value="Valores_ha"> Valores por Hectare</label>
    </div>
    <h2>Resultados por UF</h2>
    <div id="chartEstado" class="chart"></div>
    <div id="chartComparacaoEstado"></div>
    

    <h2>Resultados por Bioma</h2>

    <div id="chartBioma" class="chart"></div>
    <div id="chartComparacaoBioma"></div>

    <!-- Tooltip para mostrar os valores -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        // Função para formatar números com separador de milhares e sem casas decimais
        const formatCurrency = d3.format(",.0f");

        let originalData; // Variável global para armazenar os dados originais
        let currentValueType = "Valor"; // Padrão inicial (Valores Absolutos)

        // Carregar o CSV com ponto e vírgula como delimitador
        d3.dsv(";", "planaflor.csv").then(function(data) {
            // Converter os valores para número
            data.forEach(d => {
                d.Valor = +d.Valor;
                d.Valores_ha = +d.Valores_ha;
            });

            originalData = data;  // Armazenar os dados originais para o filtro

            // Preencher o dropdown com os valores únicos da coluna "Cenário"
            populateDropdown(data);

            // Atualizar os gráficos com base no Cenário e no Tipo de Valor selecionado
            updateCharts("all");

            // Adicionar eventos nos radio buttons para mudar o tipo de valor
            d3.selectAll('input[name="valueType"]').on("change", function() {
                currentValueType = this.value;  // Atualizar o tipo de valor (Valor ou Valores_ha)
                const selectedCenario = d3.select("#cenarioSelect").property("value");  // Cenário atual selecionado
                updateCharts(selectedCenario);
            });
        }).catch(function(error) {
            console.error('Erro ao carregar o arquivo CSV:', error);
        });

        // Função para preencher a lista suspensa com os valores únicos de "Cenário"
        function populateDropdown(data) {
            const cenarioOptions = Array.from(new Set(data.map(d => d.Cenário))); // Pegar os valores únicos de "Cenário"
            const select = d3.select("#cenarioSelect");

            // Adicionar as opções no dropdown
            cenarioOptions.forEach(cenario => {
                select.append("option")
                    .attr("value", cenario)
                    .text(cenario);
            });

            // Adicionar evento de mudança no dropdown
            select.on("change", function() {
                const selectedCenario = this.value;
                updateCharts(selectedCenario);
            });
        }

// Função para filtrar e atualizar os gráficos
// Função para filtrar e atualizar os gráficos
// Função para filtrar e atualizar os gráficos
// Função para filtrar e atualizar os gráficos
function updateCharts(cenario) {
    let filteredData;

    // Se o cenário for "all", mostrar todos os dados, caso contrário, filtrar por "Cenário"
    if (cenario === "all") {
        filteredData = originalData;
    } else {
        filteredData = originalData.filter(d => d.Cenário === cenario);
    }

    // Atualizar gráfico por Estado (já existente)
    const aggregatedDataEstado = d3.rollup(filteredData, 
        v => d3.sum(v, d => d[currentValueType]),  // Soma dos valores com base no tipo (Valor ou Valores_ha)
        d => d.Estado  // Agrupar por estado
    );
    const formattedDataEstado = Array.from(aggregatedDataEstado, ([Estado, Valor]) => ({ Estado, Valor }));
    createBarChart("#chartEstado", formattedDataEstado, "Estado");

    // Atualizar gráfico por Bioma (já existente)
    let formattedDataBioma;
    if (currentValueType === "Valor") {
        const aggregatedDataBioma = d3.rollup(filteredData, 
            v => d3.sum(v, d => d[currentValueType]),  // Soma dos valores absolutos
            d => d.Bioma  // Agrupar por bioma
        );
        formattedDataBioma = Array.from(aggregatedDataBioma, ([Bioma, Valor]) => ({ Bioma, Valor }));
    } else {
        formattedDataBioma = filteredData.map(d => ({
            Bioma: d.Bioma,
            Valor: d.Valores_ha  // Usar o valor por hectare diretamente
        }));
    }
    createBarChart("#chartBioma", formattedDataBioma, "Bioma");

    // Gráfico de comparação: serviços ecossistêmicos vs. pecuária por Bioma
    const comparisonDataBioma = Array.from(d3.rollup(filteredData, 
        v => ({
            ValorServicos: d3.sum(v, d => d[currentValueType]),  // Soma dos serviços ecossistêmicos
            ValorPecuaria: d3.sum(v, d => d.Valor_pecuaria || 0)  // Soma dos valores de pecuária, tratando undefined como 0
        }),
        d => d.Bioma  // Agrupar por bioma
    ), ([Bioma, { ValorServicos, ValorPecuaria }]) => ({
        Bioma,
        ValorServicos,
        ValorPecuaria
    }));

    createComparisonChart("#chartComparacaoBioma", comparisonDataBioma, "Bioma");

    // Gráfico de comparação: serviços ecossistêmicos vs. pecuária por Estado
    const comparisonDataEstado = Array.from(d3.rollup(filteredData, 
        v => ({
            ValorServicos: d3.sum(v, d => d[currentValueType]),  // Soma dos serviços ecossistêmicos
            ValorPecuaria: d3.sum(v, d => d.Valor_pecuaria || 0)  // Soma dos valores de pecuária
        }),
        d => d.Estado  // Agrupar por estado
    ), ([Estado, { ValorServicos, ValorPecuaria }]) => ({
        Estado,
        ValorServicos,
        ValorPecuaria
    }));

    createComparisonChart("#chartComparacaoEstado", comparisonDataEstado, "Estado");
}


        // Função para criar o gráfico comparativo entre serviços ecossistêmicos e pecuária
// Função para criar o gráfico comparativo entre serviços ecossistêmicos e pecuária
// Função para criar o gráfico comparativo entre serviços ecossistêmicos e pecuária
// Função para criar o gráfico comparativo entre serviços ecossistêmicos e pecuária
function createComparisonChart(selector, data, label) {
    // Limpar o gráfico existente
    d3.select(selector).selectAll("*").remove();

    const margin = {top: 40, right: 30, bottom: 40, left: 60},
        width = 700 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    const svg = d3.select(selector)
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // Definir as escalas
    const x = d3.scaleBand()
        .domain(data.map(d => d[label]))  // Agrupar por UF ou Bioma
        .range([0, width])
        .padding(0.2);

    const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => Math.max(d.ValorServicos, d.ValorPecuaria))])
        .nice()
        .range([height, 0]);

    // Eixos
    svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));

        svg.append("g")
    .call(d3.axisLeft(y).tickFormat(d => {
        if (d >= 1e9) {
            return (d / 1e9).toFixed(1) + " Bi";  // Para bilhões
        } else if (d >= 1e6) {
            return (d / 1e6).toFixed(1) + " Mi";  // Para milhões
        } else if (d >= 1e3) {
            return (d / 1e3).toFixed(1) + " mil";  // Para milhares
        } else {
            return d;  // Números menores não são formatados
        }
    }));


    // Barras de serviços ecossistêmicos
    svg.selectAll(".barServicos")
        .data(data)
        .enter()
        .append("rect")
        .attr("class", "barServicos")
        .attr("x", d => x(d[label]))
        .attr("y", d => y(d.ValorServicos))
        .attr("width", x.bandwidth() / 2)
        .attr("height", d => height - y(d.ValorServicos))
        .attr("fill", "#69b3a2")
        .on("mouseover", function(event, d) {
            d3.select(this)
              .attr("fill", "darkgreen");
            showTooltip(`Serviços Ecossistêmicos: R$ ${d3.format(",.0f")(d.ValorServicos)}`, event);  // Formatar valor
        })
        .on("mousemove", function(event) {
            d3.select(".tooltip")
              .style("left", `${event.pageX + 10}px`)
              .style("top", `${event.pageY + 10}px`);
        })
        .on("mouseout", function() {
            d3.select(this)
              .attr("fill", "#69b3a2");
            hideTooltip();
        });

    // Barras de pecuária
    svg.selectAll(".barPecuaria")
        .data(data)
        .enter()
        .append("rect")
        .attr("class", "barPecuaria")
        .attr("x", d => x(d[label]) + x.bandwidth() / 2)
        .attr("y", d => y(d.ValorPecuaria))
        .attr("width", x.bandwidth() / 2)
        .attr("height", d => height - y(d.ValorPecuaria))
        .attr("fill", "#ff7f0e")
        .on("mouseover", function(event, d) {
            d3.select(this)
              .attr("fill", "darkorange");
            showTooltip(`Pecuária: R$ ${d3.format(",.0f")(d.ValorPecuaria)}`, event);  // Formatar valor
        })
        .on("mousemove", function(event) {
            d3.select(".tooltip")
              .style("left", `${event.pageX + 10}px`)
              .style("top", `${event.pageY + 10}px`);
        })
        .on("mouseout", function() {
            d3.select(this)
              .attr("fill", "#ff7f0e");
            hideTooltip();
        });

    // Adicionar a legenda
    const legend = svg.append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${width - 150}, 0)`);

    legend.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 15)
        .attr("height", 15)
        .attr("fill", "#69b3a2");

    legend.append("text")
        .attr("x", 20)
        .attr("y", 12)
        .text("Serviços Ecossistêmicos");

    legend.append("rect")
        .attr("x", 0)
        .attr("y", 20)
        .attr("width", 15)
        .attr("height", 15)
        .attr("fill", "#ff7f0e");

    legend.append("text")
        .attr("x", 20)
        .attr("y", 32)
        .text("Pecuária");
}




 // Função para criar o gráfico de barras
function createBarChart(container, data, labelType) {
    // Definir as dimensões do gráfico
    const width = 800;
    const height = 400;
    const margin = { top: 20, right: 30, bottom: 40, left: 50 };

    // Remover o gráfico existente antes de criar um novo
    d3.select(container).selectAll("svg").remove();

    // Criar o SVG para o gráfico
    const svg = d3.select(container)
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // Criar escalas
    const xScale = d3.scaleBand()
        .domain(data.map(d => d[labelType]))
        .range([margin.left, width - margin.right])
        .padding(0.1);

    const yScale = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.Valor)]).nice()
        .range([height - margin.bottom, margin.top]);

    // Adicionar eixos
    svg.append("g")
        .attr("transform", `translate(0, ${height - margin.bottom})`)
        .call(d3.axisBottom(xScale));

    // Customizar o eixo Y com a formatação desejada
    svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(d3.axisLeft(yScale).tickFormat(d => {
            if (d >= 1e9) {
                return (d / 1e9).toFixed(1) + " Bi";  // Para bilhões
            } else if (d >= 1e6) {
                return (d / 1e6).toFixed(1) + " Mi";  // Para milhões
            } else if (d >= 1e3) {
                return (d / 1e3).toFixed(1) + " mil";  // Para milhares
            } else {
                return d;  // Números menores não são formatados
            }
        }));

            // Selecionar tooltip
            const tooltip = d3.select("#tooltip");

            // Criar as barras
            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => xScale(d[labelType]))
                .attr("y", d => yScale(d.Valor))
                .attr("width", xScale.bandwidth())
                .attr("height", d => height - margin.bottom - yScale(d.Valor))
                .attr("fill", "steelblue")
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("fill", "orange");
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(`${labelType}: ${d[labelType]}<br>Valor: R$ ${formatCurrency(d.Valor)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("fill", "steelblue");
                    tooltip.transition().duration(200).style("opacity", 0);
                });
        }
    </script>
        <script>
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("background", "lightgray")
                .style("border", "1px solid gray")
                .style("padding", "5px")
                .style("border-radius", "5px")
                .style("pointer-events", "none")
                .style("opacity", 0);
    
            function showTooltip(text, event) {
                tooltip.transition().duration(200)
                    .style("opacity", 1);
    
                tooltip.html(text)
                    .style("left", `${event.pageX + 10}px`)
                    .style("top", `${event.pageY + 10}px`);
            }
    
            function hideTooltip() {
                tooltip.transition().duration(200)
                    .style("opacity", 0);
            }
        </script>

<div class="topnav">
    <div>
        <img src="https://asset.brandfetch.io/idRUcHpOLl/idoBOKuc1d.png" alt="Logo da Organização" />
    </div>
    <p>© 2024 Copyright: All rights reserved.</p>

</div>
</body>
</html>
